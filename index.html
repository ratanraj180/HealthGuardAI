<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>HealthGuard AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.css">
</head>

<body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.js"></script>
    <script>
        stlite.mount({
            requirements: ["streamlit", "pandas", "sqlite3"],
            entrypoint: "app.py",
            files: {
                "app.py": `
import streamlit as st
import pandas as pd
import time
import random
from datetime import datetime
from core.database import DatabaseManager

st.set_page_config(
    page_title="HealthGuard AI Monitor",
    page_icon="üõ°Ô∏è",
    layout="wide",
)

# --- LIVE DATA GENERATION (SIMULATION) ---
try:
    db = DatabaseManager()
    
    # Check if DB is empty (first run), seed history
    if not db.get_latest_metrics(limit=1):
        components = ["cpu", "memory", "database", "api"]
        names = ["usage", "usage", "latency", "latency"]
        for i in range(20):
            for comp, name in zip(components, names):
                val = random.random() if "usage" in name else random.randint(20, 400)
                db.log_metric(comp, name, val)
    
    # Generate NEW data for this run (The "Live" part)
    cpu = 0.4 + (random.random() * 0.5) if random.random() > 0.7 else 0.2 + (random.random() * 0.3)
    mem = 0.5 + (random.random() * 0.4)
    db_lat = random.randint(20, 100) if random.random() > 0.8 else random.randint(150, 400)
    api_lat = random.randint(50, 200)

    db.log_metric("cpu", "usage", cpu)
    db.log_metric("memory", "usage", mem)
    db.log_metric("database", "latency", db_lat)
    db.log_metric("api", "latency", api_lat)

except Exception as e:
    st.error(f"Simulation Error: {e}")
# -----------------------------------------

st.title("üõ°Ô∏è HealthGuard AI: Autonomous SRE")
st.markdown("### Production Environment Simulation (Browser Demo)")
st.caption(f"Last Updated: {datetime.now().strftime('%H:%M:%S')} | Running in Browser (st-lite)")

# Refresh button
if st.button("Refresh Now"):
    st.experimental_rerun()

# --- DASHBOARD LOGIC ---
try:
    db = DatabaseManager()
    
    # Layout
    col1, col2, col3, col4 = st.columns(4)
    
    # Get Metrics
    raw_metrics = db.get_latest_metrics(limit=100)
    
    if not raw_metrics:
        st.warning("Initializing system metrics...")
        time.sleep(1)
        st.experimental_rerun()
    
    # Process latest values
    latest_metrics = {}
    for m in raw_metrics:
        # m = (id, timestamp, component, name, value)
        comp = m[2]
        name = m[3]
        val = m[4]
        key = f"{comp}_{name}"
        if key not in latest_metrics:
            latest_metrics[key] = val
            
    cpu_val = latest_metrics.get("cpu_usage", 0)
    mem_val = latest_metrics.get("memory_usage", 0)
    db_val = latest_metrics.get("database_latency", 0)
    api_val = latest_metrics.get("api_latency", 0)
    
    with col1:
        val = cpu_val * 100
        delta_color = "inverse" if val > 80 else "normal"
        st.metric("CPU Usage", f"{val:.1f}%", delta_color=delta_color)

    with col2:
        val = mem_val * 100
        st.metric("Memory Usage", f"{val:.1f}%")

    with col3:
        st.metric("DB Latency", f"{db_val:.0f}ms", delta_color="inverse")

    with col4:
        st.metric("API Latency", f"{api_val:.0f}ms")
        
    # Status Banner
    if cpu_val > 0.85:
        st.error("üö® CRITICAL: High CPU Usage Detected! Remediation Pipeline Active.")
    elif db_val > 300:
        st.warning("‚ö†Ô∏è WARNING: Database Latency High.")
    else:
        st.success("‚úÖ SYSTEM HEALTHY: All systems operational.")
        
    # Charts
    st.subheader("Live System Telemetry")
    chart_col1, chart_col2 = st.columns(2)
    
    metric_df = pd.DataFrame(raw_metrics, columns=["id", "timestamp", "Component", "Name", "Value"])
    metric_df["Component"] = metric_df["Component"].str.upper()
    
    with chart_col1:
        # Show component usage over time/avg
        st.bar_chart(metric_df.head(20).pivot_table(index="Component", values="Value", aggfunc='mean'))
        
    with chart_col2:
        st.subheader("Incident History")
        incidents = db.get_incidents()
        if incidents:
            for inc in incidents:
                with st.expander(f"{inc[1]} - {inc[3]}"):
                    st.write(f"**Root Cause:** {inc[4]}")
                    st.write(f"**Fix:** {inc[5]}")
        else:
            st.info("No incidents recorded.")

except Exception as e:
    st.error(f"Dashboard Error: {e}")

# Auto-refresh loop
time.sleep(1.5)
st.experimental_rerun()
`,
                "core/__init__.py": "",
                "core/database.py": `
import sqlite3
import json
from datetime import datetime
import os

DB_FILE = "healthguard.db"

class DatabaseManager:
    def __init__(self):
        self.conn = sqlite3.connect(DB_FILE, check_same_thread=False)
        self.create_tables()

    def create_tables(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS metrics (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp TEXT,
                component TEXT,
                name TEXT,
                value REAL
            )
        ''')
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS incidents (
                id TEXT PRIMARY KEY,
                timestamp TEXT,
                status TEXT,
                anomaly_component TEXT,
                root_cause TEXT,
                fix_action TEXT,
                full_report TEXT
            )
        ''')
        self.conn.commit()

    def log_metric(self, component, name, value):
        try:
            cursor = self.conn.cursor()
            timestamp = datetime.now().isoformat()
            cursor.execute('''
                INSERT INTO metrics (timestamp, component, name, value)
                VALUES (?, ?, ?, ?)
            ''', (timestamp, component, name, value))
            self.conn.commit()
        except Exception as e:
            print(f"DB Error (log_metric): {e}")

    def get_latest_metrics(self, limit=100):
        try:
            cursor = self.conn.cursor()
            cursor.execute('SELECT * FROM metrics ORDER BY id DESC LIMIT ?', (limit,))
            return cursor.fetchall()
        except Exception:
            return []
            
    def get_incidents(self, limit=10):
        try:
            cursor = self.conn.cursor()
            cursor.execute('SELECT * FROM incidents ORDER BY timestamp DESC LIMIT ?', (limit,))
            return cursor.fetchall()
        except Exception:
            return []
`,
                "config/__init__.py": "",
                "config/settings.py": `
THRESHOLDS = {
    "cpu.usage": 0.85,
    "memory.usage": 0.85,
    "database.latency": 300,
    "api.latency": 400
}
SIMULATION = True
SLACK_WEBHOOK_URL = ""
`
            }
        }, document.getElementById("root"))
    </script>
</body>

</html>