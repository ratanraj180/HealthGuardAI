<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>HealthGuard AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.css">
</head>

<body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.js"></script>
    <script>
        stlite.mount({
            requirements: ["streamlit", "pandas"],
            entrypoint: "app.py",
            files: {
                "app.py": `
import streamlit as st
import pandas as pd
import time
import random
from datetime import datetime

st.set_page_config(
    page_title="HealthGuard AI Monitor",
    page_icon="üõ°Ô∏è",
    layout="wide",
)

st.title("üõ°Ô∏è HealthGuard AI: Autonomous SRE")
st.markdown("### Production Environment Simulation (Browser Demo)")
st.caption(f"Last Updated: {datetime.now().strftime('%H:%M:%S')} | Running in Browser (st-lite)")

# --- SESSION STATE (The In-Memory Database) ---
if "metrics" not in st.session_state:
    st.session_state.metrics = []
    # Seed initial history
    components = ["CPU", "MEMORY", "DATABASE", "API"]
    for i in range(20):
        ts = datetime.now().strftime("%H:%M:%S")
        st.session_state.metrics.append({
            "timestamp": ts,
            "Component": "CPU",
            "Value": 0.2 + (random.random() * 0.3)
        })
        st.session_state.metrics.append({
            "timestamp": ts,
            "Component": "MEMORY",
            "Value": 0.4 + (random.random() * 0.2)
        })
        st.session_state.metrics.append({
            "timestamp": ts,
            "Component": "DATABASE",
            "Value": random.randint(20, 100)
        })
        st.session_state.metrics.append({
            "timestamp": ts,
            "Component": "API",
            "Value": random.randint(50, 150)
        })

if "incidents" not in st.session_state:
    st.session_state.incidents = []

# --- GENERATE NEW LIVE DATA ---
cpu = 0.4 + (random.random() * 0.5) if random.random() > 0.8 else 0.2 + (random.random() * 0.3)
mem = 0.5 + (random.random() * 0.4)
db_lat = random.randint(150, 400) if random.random() > 0.9 else random.randint(20, 100)
api_lat = random.randint(50, 200)

ts = datetime.now().strftime("%H:%M:%S")

# Append new data
st.session_state.metrics.append({"timestamp": ts, "Component": "CPU", "Value": cpu})
st.session_state.metrics.append({"timestamp": ts, "Component": "MEMORY", "Value": mem})
st.session_state.metrics.append({"timestamp": ts, "Component": "DATABASE", "Value": db_lat})
st.session_state.metrics.append({"timestamp": ts, "Component": "API", "Value": api_lat})

# Create incidents if threshold breached
if cpu > 0.85:
    if not st.session_state.incidents or st.session_state.incidents[0]["type"] != "CPU":
        st.session_state.incidents.insert(0, {
            "time": ts, 
            "type": "CPU", 
            "cause": "Process Stuck", 
            "fix": "Restarted Background Service"
        })

# Keep list from growing forever
if len(st.session_state.metrics) > 200:
    st.session_state.metrics = st.session_state.metrics[-200:]

# --- DASHBOARD UI ---
col1, col2, col3, col4 = st.columns(4)

with col1:
    delta_color = "inverse" if cpu > 0.80 else "normal"
    st.metric("CPU Usage", f"{cpu*100:.1f}%", delta_color=delta_color)

with col2:
    st.metric("Memory Usage", f"{mem*100:.1f}%")

with col3:
    st.metric("DB Latency", f"{db_lat}ms", delta_color="inverse")

with col4:
    st.metric("API Latency", f"{api_lat}ms")

# Status Banner
if cpu > 0.85:
    st.error("üö® CRITICAL: High CPU Usage Detected! Remediation Pipeline Active.")
elif db_lat > 300:
    st.warning("‚ö†Ô∏è WARNING: Database Latency High.")
else:
    st.success("‚úÖ SYSTEM HEALTHY: All systems operational.")

# Charts
st.subheader("Live System Telemetry")
chart_col1, chart_col2 = st.columns(2)

df = pd.DataFrame(st.session_state.metrics)

with chart_col1:
    # Charts need numerical values
    st.line_chart(df[df["Component"] == "CPU"].set_index("timestamp")["Value"])
    st.caption("CPU Usage Over Time")

with chart_col2:
    st.subheader("Incident History")
    if st.session_state.incidents:
        for inc in st.session_state.incidents:
            with st.expander(f"{inc['time']} - {inc['type']} Issue"):
                st.write(f"**Root Cause:** {inc['cause']}")
                st.write(f"**Auto-Fix:** {inc['fix']}")
    else:
        st.info("No incidents recorded.")

# Auto-refresh
if st.button("Stop Live Updates"):
    st.stop()
    
time.sleep(1)
st.experimental_rerun()
`
            }
        }, document.getElementById("root"))
    </script>
</body>

</html>